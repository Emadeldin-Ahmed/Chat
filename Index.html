<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMessages Style Chat</title>
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      height: 100vh;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
    }
    /* Login screen */
    #login-screen {
      margin: auto;
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.2);
      width: 90vw;
      max-width: 320px;
    }
    #login-screen input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #login-screen button {
      margin-top: 16px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      background-color: #007aff;
      color: white;
      cursor: pointer;
    }
    #login-screen button:hover {
      background-color: #005bb5;
    }
    #login-google {
      background-color: #4285f4;
      margin-top: 8px;
    }
    /* Main app */
    #app {
      display: none;
      height: 100vh;
      flex-direction: column;
    }
    #chat-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      background: #e5ddd5;
    }
    /* Sidebar */
    #sidebar {
      width: 280px;
      background: white;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
    }
    #sidebar header {
      padding: 16px;
      font-weight: bold;
      font-size: 18px;
      border-bottom: 1px solid #ccc;
      background: #f7f7f7;
      text-align: center;
    }
    #user-info {
      padding: 10px 16px;
      font-size: 14px;
      color: #555;
      border-bottom: 1px solid #eee;
    }
    #chat-list {
      flex: 1;
      overflow-y: auto;
    }
    .chat-item {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .chat-item:hover {
      background: #f0f0f0;
    }
    .chat-item.active {
      background: #d0eaff;
    }
    #new-private-chat {
      padding: 12px 16px;
      border-top: 1px solid #ccc;
      background: #fafafa;
      display: flex;
    }
    #new-private-chat input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    #new-private-chat button {
      margin-left: 8px;
      padding: 8px 12px;
      border: none;
      background: #007aff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    #new-private-chat button:hover {
      background: #005bb5;
    }
    /* Chat window */
    #chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ece5dd;
    }
    #chat-header {
      padding: 16px;
      font-weight: bold;
      background: #f7f7f7;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat-messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scroll-behavior: smooth;
      background: #ece5dd;
    }
    /* Chat bubble styles */
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.3;
      word-wrap: break-word;
      position: relative;
      display: inline-block;
      clear: both;
      white-space: pre-line;
      user-select: text;
    }
    .message .sender {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 12px;
      color: #555;
    }
    .message .time {
      font-size: 10px;
      color: #999;
      position: absolute;
      bottom: 4px;
      right: 10px;
    }
    .message.sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    .message.received {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    /* Input area */
    #input-area {
      padding: 12px 16px;
      background: white;
      display: flex;
      border-top: 1px solid #ccc;
    }
    #input-area textarea {
      flex: 1;
      resize: none;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 10px 14px;
      font-size: 15px;
      max-height: 100px;
      min-height: 40px;
      outline: none;
      font-family: inherit;
    }
    #input-area button {
      margin-left: 12px;
      padding: 10px 18px;
      border: none;
      background: #007aff;
      color: white;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    #input-area button:disabled {
      background: #a2cdfa;
      cursor: default;
    }
    /* Scrollbar for chat messages */
    #chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    /* Responsive */
    @media (max-width: 600px) {
      #chat-container {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        height: 140px;
        border-right: none;
        border-bottom: 1px solid #ccc;
        overflow-x: auto;
        display: flex;
        flex-direction: row;
        padding: 8px 0;
      }
      .chat-item {
        flex: 0 0 auto;
        border-bottom: none;
        border-right: 1px solid #eee;
        padding: 8px 12px;
      }
      #new-private-chat {
        width: 100%;
        border-top: none;
        padding: 0 8px;
        margin-top: 8px;
        display: flex;
      }
      #chat-window {
        flex: 1;
        min-height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen">
    <h2>Welcome to iMessages Chat</h2>
    <input id="guest-name" placeholder="Enter your guest name" maxlength="20" />
    <button id="login-guest">Join as Guest</button>
    <button id="login-google">Sign in with Google</button>
  </div>

  <!-- APP -->
  <div id="app">
    <div id="chat-container">
      <!-- Sidebar -->
      <div id="sidebar">
        <header>Chats</header>
        <div id="user-info"></div>
        <div id="chat-list"></div>
        <div id="new-private-chat">
          <input id="new-private-name" placeholder="Start private chat (name)" maxlength="20" />
          <button id="start-private-btn">Start</button>
        </div>
      </div>
      <!-- Chat Window -->
      <div id="chat-window">
        <div id="chat-header">Public Group Chat</div>
        <div id="chat-messages"></div>
        <div id="input-area">
          <textarea id="message-input" placeholder="Type a message" rows="1"></textarea>
          <button id="send-btn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    // Your Firebase config here (replace with your actual config)
    const firebaseConfig = {
  apiKey: "AIzaSyC-cQSpTcE4iKD-0WjjVacb_OLZZfGE4tg",
  authDomain: "chat-349eb.firebaseapp.com",
  projectId: "chat-349eb",
  storageBucket: "chat-349eb.firebasestorage.app",
  messagingSenderId: "144724814500",
  appId: "1:144724814500:web:22997fc512fe1338769431"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    // DOM Elements
    const loginScreen = document.getElementById('login-screen');
    const guestNameInput = document.getElementById('guest-name');
    const loginGuestBtn = document.getElementById('login-guest');
    const loginGoogleBtn = document.getElementById('login-google');

    const appDiv = document.getElementById('app');
    const userInfoDiv = document.getElementById('user-info');
    const chatListDiv = document.getElementById('chat-list');
    const newPrivateNameInput = document.getElementById('new-private-name');
    const startPrivateBtn = document.getElementById('start-private-btn');

    const chatHeader = document.getElementById('chat-header');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // State
    let currentUser = null;
    let currentChatId = 'public'; // default chat room is 'public'
    let chats = {}; // store chat metadata
    let messages = {};
    let userName = '';

    // Enable send button only if message input has text
    messageInput.addEventListener('input', () => {
      sendBtn.disabled = !messageInput.value.trim();
    });

    // Utility to create unique chat id for private chats (alphabetically ordered)
    function createPrivateChatId(userA, userB) {
      return [userA, userB].sort().join('_');
    }

    // Render chat list sidebar
    function renderChatList() {
      chatListDiv.innerHTML = '';

      // Public group chat always first
      const publicChatItem = document.createElement('div');
      publicChatItem.textContent = 'Public Group Chat';
      publicChatItem.classList.add('chat-item');
      if (currentChatId === 'public') publicChatItem.classList.add('active');
      publicChatItem.onclick = () => openChat('public', null);
      chatListDiv.appendChild(publicChatItem);

      // Private chats
      Object.entries(chats).forEach(([chatId, chat]) => {
        if (chatId === 'public') return;
        const otherUser = chat.participants.find(u => u !== userName);
        const chatItem = document.createElement('div');
        chatItem.textContent = otherUser || chatId;
        chatItem.classList.add('chat-item');
        if (currentChatId === chatId) chatItem.classList.add('active');
        chatItem.onclick = () => openChat(chatId, otherUser);
        chatListDiv.appendChild(chatItem);
      });
    }

    // Render messages in the chat window
    function renderMessages() {
      chatMessages.innerHTML = '';
      if (!messages[currentChatId]) return;
      messages[currentChatId].forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        if (msg.sender === userName) {
          msgDiv.classList.add('sent');
        } else {
          msgDiv.classList.add('received');
        }
        // Sender name above bubble for private chats or group chats
        if (currentChatId !== 'public' || (msg.sender !== userName)) {
          const senderSpan = document.createElement('div');
          senderSpan.classList.add('sender');
          senderSpan.textContent = msg.sender;
          msgDiv.appendChild(senderSpan);
        }
        // Message text
        const textSpan = document.createElement('div');
        textSpan.textContent = msg.text;
        msgDiv.appendChild(textSpan);

        // Time stamp
        const timeSpan = document.createElement('div');
        timeSpan.classList.add('time');
        const date = new Date(msg.timestamp);
        timeSpan.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        msgDiv.appendChild(timeSpan);

        chatMessages.appendChild(msgDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Open a chat by ID
    function openChat(chatId, chatName) {
      currentChatId = chatId;
      if (chatId === 'public') {
        chatHeader.textContent = 'Public Group Chat';
      } else {
        chatHeader.textContent = 'Chat with ' + (chatName || chatId);
      }
      renderChatList();
      renderMessages();
    }

    // Load chats metadata from DB
    function loadChats() {
      const chatsRef = db.ref('chats/' + userName);
      chatsRef.on('value', (snapshot) => {
        chats = snapshot.val() || {};
        renderChatList();
      });
    }

    // Load messages for current chat from DB
    function loadMessages(chatId) {
      const msgsRef = db.ref('messages/' + chatId);
      msgsRef.on('value', (snapshot) => {
        messages[chatId] = [];
        snapshot.forEach(child => {
          messages[chatId].push(child.val());
        });
        if (chatId === currentChatId) renderMessages();
      });
    }

    // Load messages for all chats the user participates in
    function loadAllMessages() {
      // Load public chat
      loadMessages('public');
      // Load private chats messages
      Object.keys(chats).forEach(chatId => {
        if (chatId !== 'public') {
          loadMessages(chatId);
        }
      });
    }

    // Save new message to DB
    function sendMessage() {
      if (!messageInput.value.trim()) return;
      const msgText = messageInput.value.trim();
      const timestamp = Date.now();
      const msgObj = {
        sender: userName,
        text: msgText,
        timestamp
      };
      const newMsgRef = db.ref('messages/' + currentChatId).push();
      newMsgRef.set(msgObj);
      messageInput.value = '';
      sendBtn.disabled = true;
    }

    // Start a private chat with another user name
    function startPrivateChat() {
      const otherName = newPrivateNameInput.value.trim();
      if (!otherName || otherName === userName) {
        alert("Enter a valid different username");
        return;
      }
      // Create chat id sorted alphabetically so both users get same chat id
      const chatId = createPrivateChatId(userName, otherName);
      // Save chat metadata for current user
      db.ref('chats/' + userName + '/' + chatId).set({
        participants: [userName, otherName],
        createdAt: Date.now()
      });
      // Save chat metadata for other user so they see it
      db.ref('chats/' + otherName + '/' + chatId).set({
        participants: [userName, otherName],
        createdAt: Date.now()
      });
      newPrivateNameInput.value = '';
      openChat(chatId, otherName);
      loadMessages(chatId);
    }

    // Show user info
    function showUserInfo() {
      userInfoDiv.textContent = 'Logged in as: ' + userName;
    }

    // Handle guest login
    loginGuestBtn.onclick = () => {
      const guest = guestNameInput.value.trim();
      if (!guest) {
        alert("Please enter a guest name");
        return;
      }
      userName = guest;
      currentUser = { displayName: guest };
      loginScreen.style.display = 'none';
      appDiv.style.display = 'flex';
      showUserInfo();
      setupUser();
    };

    // Handle Google login
    loginGoogleBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then((result) => {
        currentUser = result.user;
        userName = currentUser.displayName || currentUser.email.split('@')[0];
        loginScreen.style.display = 'none';
        appDiv.style.display = 'flex';
        showUserInfo();
        setupUser();
      }).catch(error => {
        alert('Google sign-in failed: ' + error.message);
      });
    };

    // Setup user listeners
    function setupUser() {
      loadChats();
      loadAllMessages();
      openChat('public');

      // Send message
      sendBtn.onclick = sendMessage;
      messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) sendMessage();
        }
      });

      // Start private chat
      startPrivateBtn.onclick = startPrivateChat;
    }

  </script>
</body>
</html>
